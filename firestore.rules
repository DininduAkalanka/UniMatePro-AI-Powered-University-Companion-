rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidEmail() {
      return isAuthenticated() && request.auth.token.email_verified == true;
    }
    
    // Rate limiting helper - checks if enough time has passed since last action
    function notTooFrequent(seconds) {
      return !exists(/databases/$(database)/documents/users/$(request.auth.uid)/rateLimits/lastRequest)
        || get(/databases/$(database)/documents/users/$(request.auth.uid)/rateLimits/lastRequest).data.timestamp < request.time - duration.value(seconds, 's');
    }
    
    // Validate string length
    function validStringLength(str, minLen, maxLen) {
      return str.size() >= minLen && str.size() <= maxLen;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if isOwner(userId);
      
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['email', 'name', 'createdAt', 'updatedAt'])
        && request.resource.data.email == request.auth.token.email
        && validStringLength(request.resource.data.name, 2, 100);
      
      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['name', 'studentId', 'university', 'department', 'year', 'updatedAt'])
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['name']) 
           || validStringLength(request.resource.data.name, 2, 100));
      
      allow delete: if isOwner(userId);
      
      // Rate limiting subcollection
      match /rateLimits/{doc} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================
    // COURSES COLLECTION
    // ============================================
    match /courses/{courseId} {
      // Users can only read their own courses
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can only create courses for themselves
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'name', 'code'])
        && validStringLength(request.resource.data.name, 1, 200);
      
      // Users can only update their own courses
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only delete their own courses
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // TASKS COLLECTION
    // ============================================
    match /tasks/{taskId} {
      // Users can only read their own tasks
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can only create tasks for themselves
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'title', 'status'])
        && validStringLength(request.resource.data.title, 1, 200);
      
      // Users can only update their own tasks
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only delete their own tasks
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // TIMETABLE ENTRIES
    // ============================================
    match /timetableEntries/{entryId} {
      // Users can only read their own timetable entries
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can only create timetable entries for themselves
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only update their own timetable entries
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only delete their own timetable entries
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // TIMETABLE (Alternative collection name)
    // ============================================
    match /timetable/{entryId} {
      // Users can only read their own timetable entries
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can only create timetable entries for themselves
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only update their own timetable entries
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only delete their own timetable entries
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // STUDY SESSIONS
    // ============================================
    match /studySessions/{sessionId} {
      // Users can only read their own study sessions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can only create study sessions for themselves
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.duration > 0
        && request.resource.data.duration <= 480;
      
      // Users can only update their own study sessions
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == request.auth.uid;
      
      // Users can only delete their own study sessions
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // CHAT MESSAGES
    // ============================================
    match /chatMessages/{messageId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // CHAT SESSIONS
    // ============================================
    match /chatSessions/{chatId} {
      allow read, write: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // STUDY PLANS
    // ============================================
    match /studyPlans/{planId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // STUDY PLAN ENTRIES
    // ============================================
    match /studyPlanEntries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // NOTIFICATIONS
    // ============================================
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }
    
    // ============================================
    // DEFAULT DENY - Security by default
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

