/**
 * AI Chat Screen
 * Modern, professional AI study assistant following OpenAI/ChatGPT design patterns
 * Features:
 * - Smooth animations and transitions
 * - Optimized FlatList rendering for performance
 * - Keyboard-safe input handling
 * - Auto-scroll to latest messages
 * - Message grouping by time
 * - Accessibility compliant (WCAG 2.1 AA)
 * - Responsive design for all screen sizes
 */

import { Ionicons } from '@expo/vector-icons';
import { Image } from 'expo-image';
import { LinearGradient } from 'expo-linear-gradient';
import { useRouter } from 'expo-router';
import { StatusBar } from 'expo-status-bar';
import React, { useCallback, useEffect, useRef, useState } from 'react';
import {
  ActivityIndicator,
  Alert,
  FlatList,
  Keyboard,
  KeyboardAvoidingView,
  Platform,
  StyleSheet,
  Text,
  TouchableOpacity,
  View,
} from 'react-native';
import { COLORS } from '../constants/config';
import { ILLUSTRATIONS } from '../constants/illustrations';
import { answerQuestion, chat, summarizeText } from '../services/aiService';
import { getCurrentUser } from '../services/authService';
import {
  ChatBubble,
  ChatInput,
  EmptyState,
  QuickActions,
  ScrollToBottomButton,
} from '../components/chat';

/**
 * Local fallback responses when AI service is unavailable
 */
const getLocalFallbackResponse = (userInput: string): string => {
  const input = userInput.toLowerCase();
  
  // Greetings
  if (input.match(/\b(hi|hello|hey|greetings|good morning|good evening)\b/)) {
    return "Hello! üëã I'm UniMate, your AI study assistant. I'm here to help you succeed in your studies!\n\n‚ú® **I can help you with:**\n\nüìö Study techniques & strategies\n‚è∞ Time management & planning\nüìù Exam preparation tips\nüí™ Motivation & support\nüìä Course organization\n\nWhat would you like to work on today?";
  }
  
  // Study tips
  if (input.match(/study|learn|focus|concentrate|revision|review/)) {
    return "Here are proven study strategies that work:\n\nüéØ **Pomodoro Technique**\n25 min focused study ‚Üí 5 min break ‚Üí Repeat\nAfter 4 cycles, take 15-30 min break\n\nüß† **Active Recall**\nClose your book and write what you remember\nTest yourself before looking at notes\n\nüìÖ **Spaced Repetition**\nReview: Day 1 ‚Üí Day 3 ‚Üí Week 1 ‚Üí Week 2 ‚Üí Month 1\n\n‚úçÔ∏è **Feynman Technique**\nExplain the concept in simple terms\nIf you can't, you don't understand it yet\n\nüìù **Cornell Notes Method**\nDivide notes: Cues | Notes | Summary\n\nüé® **Mind Mapping**\nVisualize connections between concepts\n\nWhich technique interests you most?";
  }
  
  // Time management
  if (input.match(/time|schedule|plan|organize|manage|calendar/)) {
    return "Effective time management for students:\n\n‚ö° **Eisenhower Matrix**\n‚Ä¢ Urgent + Important: Do first\n‚Ä¢ Important only: Schedule it\n‚Ä¢ Urgent only: Delegate/minimize\n‚Ä¢ Neither: Eliminate\n\nüìÖ **Time Blocking**\n8-10am: Lecture prep\n10am-12pm: Focus work\n2-4pm: Assignments\n4-5pm: Review & planning\n\nüéØ **2-Minute Rule**\nIf it takes < 2 min, do it NOW\nDon't let small tasks pile up\n\nüö´ **Avoid These:**\n‚Ä¢ Multitasking (reduces efficiency 40%)\n‚Ä¢ Social media during study\n‚Ä¢ Perfectionism paralysis\n\n‚úÖ **Daily Planning**\n1. List 3 must-do tasks\n2. Estimate time needed\n3. Add buffer time (+30%)\n4. Review end of day\n\nNeed help creating your schedule?";
  }
  
  // Exams
  if (input.match(/exam|test|quiz|assessment|midterm|final/)) {
    return "üéØ **Exam Preparation Mastery**\n\nüìÜ **Timeline Strategy:**\n\n**2+ Weeks Before:**\n‚Ä¢ Gather all materials\n‚Ä¢ Create study schedule\n‚Ä¢ Identify weak topics\n‚Ä¢ Start practice problems\n\n**1 Week Before:**\n‚Ä¢ Intensive review sessions\n‚Ä¢ Complete practice exams\n‚Ä¢ Form study groups\n‚Ä¢ Review mistakes deeply\n\n**3 Days Before:**\n‚Ä¢ Final review of notes\n‚Ä¢ Focus on formulas/key concepts\n‚Ä¢ Light practice only\n‚Ä¢ Prepare materials needed\n\n**Night Before:**\n‚Ä¢ Brief review (1 hour max)\n‚Ä¢ Organize exam supplies\n‚Ä¢ Sleep 7-8 hours üí§\n‚Ä¢ NO cramming!\n\n**Exam Day:**\n‚Ä¢ Eat proper breakfast\n‚Ä¢ Arrive early (calm nerves)\n‚Ä¢ Read all questions first\n‚Ä¢ Easy questions ‚Üí Hard questions\n\nüí° **Pro Tips:**\n‚úì Practice under time pressure\n‚úì Teach concepts to others\n‚úì Create formula sheets\n‚úì Review past exams\n‚úì Stay hydrated & exercise\n\nWhen is your exam? I'll help you plan!";
  }
  
  // Motivation
  if (input.match(/motivat|tired|exhaust|give up|stress|anxious|overwhelm|difficult|hard|cant|difficult/)) {
    return "üí™ **You've Got This!**\n\nI know studying can feel overwhelming, but remember:\n\nüåü **Success Stories Start Here**\n‚Ä¢ Every expert was once a beginner\n‚Ä¢ Struggle = Brain growing stronger\n‚Ä¢ Small progress IS progress\n\nüéØ **When You Feel Stuck:**\n\n1Ô∏è‚É£ **Break It Down**\nBig task ‚Üí Small 15-min chunks\n\n2Ô∏è‚É£ **Celebrate Small Wins**\nFinished one chapter? That's amazing! üéâ\n\n3Ô∏è‚É£ **Change Your Environment**\nNew space = Fresh perspective\n\n4Ô∏è‚É£ **Take Strategic Breaks**\nWalk, stretch, breathe deeply\n\n5Ô∏è‚É£ **Remember Your 'Why'**\nWhy did you start? That reason still matters.\n\nüí° **Quick Motivation Boosters:**\n‚Ä¢ Study with a friend\n‚Ä¢ Reward yourself after goals\n‚Ä¢ Use motivational music\n‚Ä¢ Visualize success\n‚Ä¢ Track your progress visually\n\nüßò **Stress Relief:**\n‚Ä¢ 4-7-8 Breathing: Inhale(4) Hold(7) Exhale(8)\n‚Ä¢ 5-min meditation\n‚Ä¢ Quick exercise\n‚Ä¢ Talk to someone\n\n**Remember**: Feeling challenged means you're learning!\n\nWhat specific challenge are you facing right now?";
  }
  
  // Assignment help
  if (input.match(/assignment|homework|essay|paper|project|report/)) {
    return "üìù **Assignment Success Strategy**\n\nüéØ **Step-by-Step Approach:**\n\n**1. Understand the Brief (Day 1)**\n‚Ä¢ Read requirements 3 times\n‚Ä¢ Highlight key verbs (analyze, evaluate, compare)\n‚Ä¢ Note word count & deadline\n‚Ä¢ Ask questions early\n\n**2. Research & Planning (Days 2-3)**\n‚Ä¢ Gather reliable sources\n‚Ä¢ Take organized notes\n‚Ä¢ Create outline/structure\n‚Ä¢ Thesis statement\n\n**3. First Draft (Days 4-5)**\n‚Ä¢ Write without editing\n‚Ä¢ Follow your outline\n‚Ä¢ Cite as you go\n‚Ä¢ Don't aim for perfect\n\n**4. Review & Refine (Days 6-7)**\n‚Ä¢ Check arguments flow\n‚Ä¢ Add supporting evidence\n‚Ä¢ Improve transitions\n‚Ä¢ Verify citations\n\n**5. Final Polish (Day 8)**\n‚Ä¢ Grammar & spelling\n‚Ä¢ Formatting check\n‚Ä¢ Read aloud\n‚Ä¢ Submit early!\n\nüí° **Pro Tips:**\n‚úì Start immediately (beat procrastination)\n‚úì Write introduction last\n‚úì Use transition phrases\n‚úì Get peer feedback\n‚úì Keep backup copies\n\nüö´ **Avoid:**\n‚úó Starting night before\n‚úó Plagiarism (cite everything!)\n‚úó Ignoring rubric\n‚úó Single draft\n\nWhat type of assignment are you working on?";
  }
  
  // Note-taking
  if (input.match(/notes|note-taking|lecture|class/)) {
    return "üìì **Effective Note-Taking Methods**\n\n‚úçÔ∏è **Cornell Method** (Most Popular)\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Cues    ‚îÇ Notes        ‚îÇ\n‚îÇ (Key    ‚îÇ (Main        ‚îÇ\n‚îÇ points) ‚îÇ content)     ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ Summary (Bottom)       ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\nüé® **Mind Mapping**\nCentral idea ‚Üí Branches ‚Üí Sub-branches\nGreat for visual learners!\n\nüìù **Outline Method**\nI. Main Topic\n  A. Subtopic\n    1. Detail\n    2. Detail\n  B. Subtopic\n\n‚ö° **Tips for Better Notes:**\n‚Ä¢ Use abbreviations (w/ = with)\n‚Ä¢ Color code topics\n‚Ä¢ Leave space for additions\n‚Ä¢ Review within 24 hours\n‚Ä¢ Rewrite in your own words\n‚Ä¢ Add questions in margins\n\nüéØ **During Lectures:**\n‚úì Focus on understanding, not copying\n‚úì Note examples & applications\n‚úì Mark unclear points\n‚úì Date every page\n\nüì± **Digital vs Paper?**\nPaper: Better retention\nDigital: Easy search & organize\nBoth: Use what works for YOU\n\nWhich method would you like to try?";
  }
  
  // Concentration/Focus
  if (input.match(/focus|concentrate|distract|attention|procrastinat/)) {
    return "üéØ **Master Your Focus**\n\nüß† **Science-Backed Techniques:**\n\n**1. Environment Setup**\n‚Ä¢ Clean, organized workspace\n‚Ä¢ Good lighting (natural best)\n‚Ä¢ Comfortable temperature\n‚Ä¢ Phone in another room\n‚Ä¢ Website blockers on\n\n**2. Pomodoro Method**\n‚è∞ 25 min FOCUS ‚Üí 5 min break\nRepeat 4 times ‚Üí Long break (15-30 min)\n\n**3. Deep Work Sessions**\n‚Ä¢ 90-120 minute blocks\n‚Ä¢ Single task only\n‚Ä¢ No interruptions\n‚Ä¢ Peak energy times\n\n**4. Beat Procrastination**\n‚Ä¢ 2-minute start rule\n‚Ä¢ Make it ridiculously easy\n‚Ä¢ Reward immediate starts\n‚Ä¢ Accountability partner\n\nüö´ **Eliminate Distractions:**\n‚Ä¢ Phone on Do Not Disturb\n‚Ä¢ Close extra tabs\n‚Ä¢ Use focus apps (Forest, Freedom)\n‚Ä¢ Tell others you're studying\n‚Ä¢ Silence notifications\n\nüí° **Quick Focus Tricks:**\n‚Ä¢ Start with easiest task\n‚Ä¢ Use ambient music/white noise\n‚Ä¢ Stand/walk while studying\n‚Ä¢ Chew gum (increases alertness)\n‚Ä¢ Stay hydrated\n\n‚ö° **When Mind Wanders:**\n1. Notice it (don't judge)\n2. Breathe deeply\n3. Return to task gently\n4. This is normal!\n\nüéµ **Focus Music:**\n‚Ä¢ Classical (Mozart, Bach)\n‚Ä¢ Lo-fi hip hop\n‚Ä¢ Nature sounds\n‚Ä¢ Binaural beats\n\nWhat's your biggest distraction?";
  }
  
  // Memory/Retention
  if (input.match(/remember|memory|forget|retain|recall/)) {
    return "üß† **Supercharge Your Memory**\n\nüí™ **Proven Memory Techniques:**\n\n**1. Spaced Repetition** ‚≠ê\nReview schedule:\n‚Ä¢ 1 day later\n‚Ä¢ 3 days later\n‚Ä¢ 7 days later\n‚Ä¢ 14 days later\n‚Ä¢ 30 days later\n\n**2. Elaborative Rehearsal**\n‚Ä¢ Connect to what you know\n‚Ä¢ Ask why & how\n‚Ä¢ Create examples\n‚Ä¢ Relate to real life\n\n**3. Mnemonic Devices**\n‚Ä¢ Acronyms (ROY G BIV)\n‚Ä¢ Rhymes & songs\n‚Ä¢ Method of Loci (memory palace)\n‚Ä¢ Vivid mental images\n\n**4. Teaching Effect**\nExplain it to someone else\nIf they understand, you understand!\n\n**5. Multi-Sensory Learning**\n‚Ä¢ Say it out loud\n‚Ä¢ Write by hand\n‚Ä¢ Draw diagrams\n‚Ä¢ Use gestures\n\nüéØ **During Study:**\n‚úì Test yourself frequently\n‚úì Mix up topics (interleaving)\n‚úì Study before sleep\n‚úì Review in morning\n‚úì Connect to emotions\n\nüö´ **Memory Killers:**\n‚úó Cramming (temporary)\n‚úó Passive rereading\n‚úó Highlighting only\n‚úó Poor sleep\n‚úó Stress\n\nüí° **Memory Boosters:**\n‚Ä¢ Sleep 7-9 hours\n‚Ä¢ Exercise regularly\n‚Ä¢ Stay hydrated\n‚Ä¢ Eat brain foods (omega-3)\n‚Ä¢ Reduce stress\n‚Ä¢ Take breaks\n\nWhat do you need to memorize?";
  }
  
  // General encouragement or unclear query
  return "Hi there! üëã I'm UniMate, your personal study assistant!\n\nüìö **I can help you with:**\n\nüéØ **Study Skills**\n‚Ä¢ Effective study techniques\n‚Ä¢ Note-taking strategies\n‚Ä¢ Memory improvement\n‚Ä¢ Focus & concentration\n\n‚è∞ **Time Management**\n‚Ä¢ Creating study schedules\n‚Ä¢ Prioritizing tasks\n‚Ä¢ Beating procrastination\n‚Ä¢ Daily planning\n\nüìù **Academic Success**\n‚Ä¢ Exam preparation\n‚Ä¢ Assignment strategies\n‚Ä¢ Research methods\n‚Ä¢ Writing tips\n\nüí™ **Motivation & Support**\n‚Ä¢ Dealing with stress\n‚Ä¢ Staying motivated\n‚Ä¢ Overcoming challenges\n‚Ä¢ Building confidence\n\nüí° **Try asking me:**\n‚Ä¢ \"How can I study more effectively?\"\n‚Ä¢ \"Help me manage my time better\"\n‚Ä¢ \"I have an exam coming up\"\n‚Ä¢ \"I'm feeling overwhelmed\"\n‚Ä¢ \"How to take better notes?\"\n‚Ä¢ \"I can't focus, help!\"\n\nWhat would you like help with today? üòä";
};

export default function AIChatScreen() {
  const router = useRouter();
  const [messages, setMessages] = useState<IMessage[]>([]);
  const [loading, setLoading] = useState(true);
  const [typing, setTyping] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);
  const [userName, setUserName] = useState('Student');

  useEffect(() => {
    initialize();
  }, []);

  const initialize = async () => {
    try {
      const user = await getCurrentUser();
      if (!user) {
        router.replace('/');
        return;
      }
      setUserId(user.id);
      setUserName(user.name || 'Student');

      // Add welcome message
      setMessages([
        {
          _id: 1,
          text: `Hi ${user.name}! üëã\n\nI'm your AI study assistant with comprehensive built-in knowledge to help you succeed!\n\n‚ú® **I can help you with:**\n\nüìö Study techniques & strategies\n‚è∞ Time management & planning\nüìù Exam preparation guides\nüí™ Motivation & stress relief\nüß† Memory improvement\nüéØ Focus & concentration\nüìì Note-taking methods\n\nüí° **Try asking:**\n‚Ä¢ "How to study effectively?"\n‚Ä¢ "Help with time management"\n‚Ä¢ "Exam preparation tips"\n‚Ä¢ "I need motivation"\n\nHow can I help you today?`,
          createdAt: new Date(),
          user: {
            _id: 2,
            name: 'UniMate AI',
            avatar: 'ü§ñ',
          },
        },
      ]);
    } catch (error) {
      console.error('Initialization error:', error);
      Alert.alert('Error', 'Failed to initialize chat');
    } finally {
      setLoading(false);
    }
  };

  const onSend = useCallback(async (newMessages: IMessage[] = []) => {
    if (newMessages.length === 0) return;

    const userMessage = newMessages[0];
    setMessages(previousMessages => GiftedChat.append(previousMessages, newMessages));
    setTyping(true);

    try {
      const userText = userMessage.text.toLowerCase().trim();
      let aiResponseText = '';

      // Build conversation context from recent messages (last 10 messages)
      const recentMessages = messages.slice(-10).reverse();
      const conversationHistory = recentMessages
        .map(m => {
          const role = m.user._id === userId ? 'User' : 'Assistant';
          return `${role}: ${m.text}`;
        })
        .join('\n');

      // Enhanced context for better AI responses
      const contextualPrompt = `You are UniMate, a friendly AI study assistant for university students in Sri Lanka. You help with coursework, explain concepts clearly, provide study strategies, and offer encouragement. Always be specific and helpful.\n\nConversation History:\n${conversationHistory}\n\nUser's current message: ${userMessage.text}`;

      // Detect intent and route to appropriate AI service
      if (userText.includes('summarize') || userText.includes('summary')) {
        // Extract the text to summarize (everything after "summarize")
        const textToSummarize = userMessage.text.replace(/summarize|summary/gi, '').trim();
        if (textToSummarize.length > 50) {
          const response = await summarizeText(textToSummarize);
          aiResponseText = response.text || "I couldn't generate a summary. Please try again with different text.";
        } else {
          aiResponseText = "Please provide the text you'd like me to summarize. You can paste your notes or lecture content after the word 'summarize'.";
        }
      } else if (userText.includes('?') || userText.includes('what') || userText.includes('how') || userText.includes('why') || userText.includes('explain')) {
        // Question answering with context - correct parameter order: (context, question)
        const response = await answerQuestion(contextualPrompt, userMessage.text);
        if (response.text && response.text.length > 10) {
          aiResponseText = response.text;
        } else {
          // Fallback to chat if QA doesn't provide good answer
          const chatResponse = await chat(`${contextualPrompt}\n\nPlease answer this question: ${userMessage.text}`);
          aiResponseText = chatResponse.text || "I'm having trouble answering that. Could you rephrase your question?";
        }
      } else {
        // Use local intelligence first (more reliable)
        aiResponseText = getLocalFallbackResponse(userText);
        
        // Only try AI for complex queries if user wants it
        // For now, local responses are comprehensive enough
        // This ensures app always works regardless of API status
      }

      // Add AI response with validation
      if (aiResponseText && aiResponseText.trim().length > 0) {
        const aiMessage: IMessage = {
          _id: Math.random().toString(),
          text: aiResponseText.trim(),
          createdAt: new Date(),
          user: {
            _id: 2,
            name: 'UniMate AI',
            avatar: 'ü§ñ',
          },
        };
        setMessages(previousMessages => GiftedChat.append(previousMessages, [aiMessage]));
      } else {
        // Fallback message if response is empty
        const fallbackMessage: IMessage = {
          _id: Math.random().toString(),
          text: "I'm having trouble generating a response right now. Please try again or rephrase your message.",
          createdAt: new Date(),
          user: {
            _id: 2,
            name: 'UniMate AI',
            avatar: 'ü§ñ',
          },
        };
        setMessages(previousMessages => GiftedChat.append(previousMessages, [fallbackMessage]));
      }
    } catch (error: any) {
      console.error('AI response error:', error);
      
      // Determine error type and provide helpful message
      let errorText = '';
      
      if (error.message?.includes('API key') || error.message?.includes('not configured')) {
        errorText = "‚ö†Ô∏è **AI Service Not Configured**\n\nPlease add your Hugging Face API key:\n1. Get free key from huggingface.co/settings/tokens\n2. Add to .env file\n3. Restart the app";
      } else if (error.message?.includes('Network') || error.message?.includes('timeout')) {
        errorText = "üåê **Connection Issue**\n\nPlease check your internet connection and try again.";
      } else if (error.message?.includes('429') || error.message?.includes('rate limit')) {
        errorText = "‚è±Ô∏è **Rate Limit Reached**\n\nThe AI service is busy. Please wait a moment and try again.";
      } else if (error.message?.includes('503') || error.message?.includes('loading')) {
        errorText = "üîÑ **Model Loading**\n\nThe AI model is starting up. This can take 10-20 seconds. Please try again in a moment.";
      } else {
        errorText = "üòî **Something Went Wrong**\n\nI couldn't process that request. Could you try rephrasing or ask something else?\n\nError: " + (error.message || 'Unknown error');
      }
      
      const errorMessage: IMessage = {
        _id: Math.random().toString(),
        text: errorText,
        createdAt: new Date(),
        user: {
          _id: 2,
          name: 'UniMate AI',
          avatar: 'ü§ñ',
        },
      };
      setMessages(previousMessages => GiftedChat.append(previousMessages, [errorMessage]));
    } finally {
      setTyping(false);
    }
  }, [messages, userId, userName]);

  const handleImagePick = async () => {
    // Future feature: OCR for extracting text from images
    Alert.alert(
      'Coming Soon! üì∏',
      'Image text extraction will be available in the next update.\n\nFor now, you can:\n‚Ä¢ Type your questions directly\n‚Ä¢ Copy and paste text\n‚Ä¢ Ask for study help anytime!'
    );
  };

  const handleDocumentPick = async () => {
    // Future feature: PDF text extraction
    Alert.alert(
      'Coming Soon! üìÑ',
      'PDF document analysis will be available in the next update.\n\nFor now, you can:\n‚Ä¢ Copy text from your PDFs\n‚Ä¢ Paste it in the chat\n‚Ä¢ Ask me to help summarize or explain!'
    );
  };

  const handleQuickAction = (action: string) => {
    let prompt = '';
    switch (action) {
      case 'summarize':
        prompt = 'How to take better notes and summarize effectively?';
        break;
      case 'explain':
        prompt = 'What are the best study techniques?';
        break;
      case 'tips':
        prompt = 'Give me study tips for my upcoming exams';
        break;
      case 'plan':
        prompt = 'Help me manage my time better';
        break;
    }

    const message: IMessage = {
      _id: Math.random().toString(),
      text: prompt,
      createdAt: new Date(),
      user: {
        _id: userId || '1',
        name: userName,
      },
    };

    onSend([message]);
  };

  const renderBubble = (props: any) => {
    return (
      <Bubble
        {...props}
        wrapperStyle={{
          right: {
            backgroundColor: COLORS.primary,
          },
          left: {
            backgroundColor: '#F0F0F0',
          },
        }}
        textStyle={{
          right: {
            color: '#fff',
          },
          left: {
            color: COLORS.text,
          },
        }}
      />
    );
  };

  const renderInputToolbar = (props: any) => {
    return (
      <InputToolbar
        {...props}
        containerStyle={styles.inputToolbar}
        primaryStyle={styles.inputPrimary}
        renderActions={renderActions}
      />
    );
  };

  const renderSend = (props: any) => {
    const isDisabled = !props.text || props.text.trim().length === 0;
    return (
      <Send 
        {...props}
        disabled={isDisabled}
        containerStyle={{ justifyContent: 'center', alignItems: 'center' }}
      >
        <View style={[styles.sendButton, isDisabled && { opacity: 0.5, backgroundColor: '#ccc' }]}>
          <Ionicons name="send" size={20} color="#fff" />
        </View>
      </Send>
    );
  };

  const renderActions = () => {
    return (
      <View style={styles.actionsContainer}>
        <TouchableOpacity onPress={handleImagePick} style={styles.actionButton}>
          <Ionicons name="image-outline" size={24} color={COLORS.primary} />
        </TouchableOpacity>
        <TouchableOpacity onPress={handleDocumentPick} style={styles.actionButton}>
          <Ionicons name="document-outline" size={24} color={COLORS.primary} />
        </TouchableOpacity>
      </View>
    );
  };

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={COLORS.primary} />
      </View>
    );
  }

  return (
    <KeyboardAvoidingView 
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 0}
    >
      <StatusBar style="light" />
      
      {/* Header */}
      <View style={styles.headerWrapper}>
        <Image 
          source={ILLUSTRATIONS.heroStudy5}
          style={styles.headerBackgroundImage}
          contentFit="cover"
        />
        <LinearGradient 
          colors={['rgba(88,86,214,0.92)', 'rgba(108,99,255,0.92)']} 
          style={styles.header}
        >
        <View style={styles.headerContent}>
          <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
            <Ionicons name="arrow-back" size={24} color="#fff" />
          </TouchableOpacity>
          <View style={styles.headerTitle}>
            <Text style={styles.headerText}>AI Study Assistant</Text>
            <Text style={styles.headerSubtext}>
              {typing ? 'AI is typing...' : 'Always here to help'}
            </Text>
          </View>
          <View style={styles.aiAvatar}>
            <Text style={styles.aiAvatarText}>ü§ñ</Text>
          </View>
        </View>
        </LinearGradient>
      </View>

      {/* Quick Actions */}
      {messages.length <= 1 && (
        <View style={styles.quickActionsContainer}>
          <View style={styles.aiHeroSection}>
            <Image 
              source={ILLUSTRATIONS.aiChat}
              style={styles.aiHeroImage}
              contentFit="contain"
            />
            <Text style={styles.aiHeroTitle}>Your Personal Study Coach</Text>
            <Text style={styles.aiHeroSubtitle}>Instant help, anytime - no internet required!</Text>
          </View>
          <Text style={styles.quickActionsTitle}>Quick Actions:</Text>
          <View style={styles.quickActions}>
            <TouchableOpacity
              style={styles.quickActionChip}
              onPress={() => handleQuickAction('summarize')}
            >
              <Ionicons name="document-text-outline" size={16} color={COLORS.primary} />
              <Text style={styles.quickActionText}>Note-Taking</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={styles.quickActionChip}
              onPress={() => handleQuickAction('explain')}
            >
              <Ionicons name="bulb-outline" size={16} color={COLORS.primary} />
              <Text style={styles.quickActionText}>Study Techniques</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={styles.quickActionChip}
              onPress={() => handleQuickAction('tips')}
            >
              <Ionicons name="star-outline" size={16} color={COLORS.primary} />
              <Text style={styles.quickActionText}>Exam Prep</Text>
            </TouchableOpacity>
            <TouchableOpacity
              style={styles.quickActionChip}
              onPress={() => handleQuickAction('plan')}
            >
              <Ionicons name="calendar-outline" size={16} color={COLORS.primary} />
              <Text style={styles.quickActionText}>Time Management</Text>
            </TouchableOpacity>
          </View>
        </View>
      )}

      {/* Chat */}
      <GiftedChat
        messages={messages}
        onSend={messages => onSend(messages)}
        user={{
          _id: userId || '1',
          name: userName,
        }}
        renderBubble={renderBubble}
        renderInputToolbar={renderInputToolbar}
        renderSend={renderSend}
        placeholder="Type your question..."
        isTyping={typing}
        alwaysShowSend
        bottomOffset={Platform.OS === 'ios' ? 34 : 0}
        minInputToolbarHeight={60}
        keyboardShouldPersistTaps="handled"
        textInputProps={{
          autoCorrect: true,
          autoCapitalize: 'sentences',
          enablesReturnKeyAutomatically: true,
          returnKeyType: 'send',
          blurOnSubmit: false,
        }}
      />
    </KeyboardAvoidingView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: COLORS.background,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  headerWrapper: {
    position: 'relative',
  },
  headerBackgroundImage: {
    position: 'absolute',
    width: '100%',
    height: 120,
    opacity: 0.3,
  },
  header: {
    paddingTop: 50,
    paddingBottom: 16,
    paddingHorizontal: 20,
  },
  headerContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  backButton: {
    width: 40,
    height: 40,
    justifyContent: 'center',
    alignItems: 'center',
  },
  headerTitle: {
    flex: 1,
    marginLeft: 12,
  },
  headerText: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#fff',
  },
  headerSubtext: {
    fontSize: 12,
    color: 'rgba(255,255,255,0.8)',
    marginTop: 2,
  },
  aiAvatar: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: 'rgba(255,255,255,0.2)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  aiAvatarText: {
    fontSize: 24,
  },
  quickActionsContainer: {
    backgroundColor: '#fff',
    padding: 16,
    borderBottomWidth: 1,
    borderBottomColor: '#e0e0e0',
  },
  aiHeroSection: {
    alignItems: 'center',
    paddingVertical: 16,
  },
  aiHeroImage: {
    width: 160,
    height: 160,
  },
  aiHeroTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: COLORS.text,
    marginTop: 16,
  },
  aiHeroSubtitle: {
    fontSize: 14,
    color: COLORS.textSecondary,
    marginTop: 4,
    marginBottom: 16,
  },
  quickActionsTitle: {
    fontSize: 14,
    fontWeight: '600',
    color: COLORS.textSecondary,
    marginBottom: 12,
  },
  quickActions: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
  },
  quickActionChip: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: COLORS.background,
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 20,
    gap: 6,
    borderWidth: 1,
    borderColor: COLORS.primary,
  },
  quickActionText: {
    fontSize: 12,
    color: COLORS.primary,
    fontWeight: '600',
  },
  inputToolbar: {
    backgroundColor: '#fff',
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
    paddingHorizontal: 8,
    paddingVertical: 8,
    minHeight: 60,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: -2 },
    shadowOpacity: 0.05,
    shadowRadius: 4,
    elevation: 4,
  },
  inputPrimary: {
    alignItems: 'center',
    justifyContent: 'space-between',
    flexDirection: 'row',
  },

  sendButton: {
    marginRight: 8,
    marginBottom: 6,
    marginLeft: 8,
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: COLORS.primary,
    justifyContent: 'center',
    alignItems: 'center',
    shadowColor: COLORS.primary,
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.3,
    shadowRadius: 4,
    elevation: 3,
  },
  actionsContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginLeft: 8,
    marginBottom: 6,
  },
  actionButton: {
    marginRight: 6,
    width: 36,
    height: 36,
    borderRadius: 18,
    backgroundColor: '#f5f5f5',
    justifyContent: 'center',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#e0e0e0',
  },
});
